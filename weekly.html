<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Weekly Plan â€¢ Spend Battles</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <link rel="stylesheet" href="./css/style.css" />
</head>
<body>

  <div class="app">

    <section class="card big">
      <h2>ðŸ“… Weekly Commitment</h2>
      <p class="muted">
        Set this once. No edits. No excuses.
      </p>
    </section>

    <section class="card">
      <label>Weekly Spend Goal (â‚¹)</label>
      <input id="weeklySpend" type="number" placeholder="e.g. 1000" />

      <label>Weekly Saving Goal (â‚¹)</label>
      <input id="weeklySave" type="number" placeholder="e.g. 500" />

      <p class="muted small">
        Daily target = Weekly Spend Ã· 7  
        <br>
        (Weâ€™ll remind you when you mess up)
      </p>

      <button id="savePlan" class="primary">
        Lock my plan ðŸ”’
      </button>

      <p id="status" class="success"></p>
    </section>

  </div>

  <script type="module">
    import { supabase } from "./js/supabase.js";

    function getMonday(date = new Date()) {
      const d = new Date(date);
      const day = d.getDay();
      const diff = d.getDate() - day + (day === 0 ? -6 : 1);
      return new Date(d.setDate(diff)).toISOString().split("T")[0];
    }

    document.getElementById("savePlan").onclick = async () => {
      const weeklySpend = Number(document.getElementById("weeklySpend").value);
      const weeklySave = Number(document.getElementById("weeklySave").value);
      const status = document.getElementById("status");

      if (!weeklySpend || weeklySpend <= 0) {
        status.innerText = "Enter a valid weekly spend";
        return;
      }

      const { data: userData } = await supabase.auth.getUser();
      const user = userData.user;
      if (!user) return;

      const monday = getMonday();

      const { error } = await supabase
        .from("weekly_plan")
        .insert({
          user_id: user.id,
          week_start: monday,
          weekly_spend: weeklySpend,
          weekly_save: weeklySave || 0
        });

      if (error) {
        status.innerText = error.message;
      } else {
        status.innerText = "Plan locked. Donâ€™t embarrass yourself now ðŸ˜¤";
        setTimeout(() => {
          window.location.href = "/home.html";
        }, 1000);
      }
    };
  </script>

</body>
</html>
